---
import About from "@/components/About.astro";
import ExperienceCard from "@/components/ExperienceCard.astro";
import Footer from "@/components/Footer.astro";
import Header from "@/components/Header.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import { Button } from "@/components/ui/button";
import Layout from "@/layouts/Layout.astro";
import { parseFrontmatterDate } from "@/lib/dateFormatter";
import { type GitHubRepo, getGithubProjects } from "@/lib/github";
import { getCollection, type CollectionEntry } from "astro:content";
import { ArrowDown, ArrowUpRight } from "lucide-react";

// Fetch GitHub projects and experiences
const projects: GitHubRepo[] = await getGithubProjects();

// Sort experiences by start date - typed for TypeScript
type Experience = CollectionEntry<"experiences">;
const experiences: Experience[] = (await getCollection("experiences")).sort(
  (a: Experience, b: Experience) => {
    const aStart = parseFrontmatterDate(a.data.startDate);
    const bStart = parseFrontmatterDate(b.data.startDate);
    return bStart.getTime() - aStart.getTime();
  }
);
---

<Layout>
  <div
    class="mx-auto min-h-screen max-w-screen-xl lg:px-6 lg:flex lg:justify-between lg:gap-4"
  >
    {/* Header */}
    <Header />

    {/* Main content */}
    <main id="main-content" class="lg:w-[52%]">
      {/* About */}
      <section id="about" class="py-20">
        <div
          class="bg-white/90 px-6 py-5 backdrop-blur-sm sticky top-0 z-10 lg:hidden dark:bg-background/90"
        >
          <h2 class="font-bold uppercase tracking-widest">About</h2>
        </div>
        <About />
      </section>

      {/* Projects */}
      <section id="projects" class="pb-20 scroll-mt-20">
        <div
          class="bg-white/90 px-6 py-5 backdrop-blur-sm sticky top-0 z-10 lg:hidden dark:bg-background/90"
        >
          <h2 class="font-bold uppercase tracking-widest">Projects</h2>
        </div>
        {projects.map((project) => <ProjectCard {...project} />)}
        <a
          href="https://github.com/mrearsbig"
          target="_blank"
          rel="noopener noreferrer"
          class="px-3 group"
          aria-label="Ver historial completo de proyectos en GitHub"
          ><Button
            variant="link"
            className="text-black text-base font-semibold hover:text-primary dark:text-white dark:hover:text-primary"
            >View Project History <ArrowUpRight
              strokeWidth={3}
              className="transition-transform group-hover:translate-x-1 group-hover:-translate-y-1"
            /></Button
          ></a
        >
      </section>

      {/* Experience */}
      <section id="experience" class="pb-20 scroll-mt-20">
        <div
          class="bg-white/90 px-6 py-5 backdrop-blur-sm sticky top-0 z-10 lg:hidden dark:bg-background/90"
        >
          <h2 class="font-bold uppercase tracking-widest">Experience</h2>
        </div>
        {
          experiences.map((exp) => (
            <ExperienceCard {...exp.data}>{exp.body}</ExperienceCard>
          ))
        }
        <a
          href="/resume.pdf"
          target="_blank"
          rel="noopener noreferrer"
          class="px-3 group"
          aria-label="Descargar currÃ­culum completo en PDF"
          ><Button
            variant="link"
            className="text-black text-base font-semibold hover:text-primary dark:text-white dark:hover:text-primary"
            >View Complete Resume <ArrowDown
              strokeWidth={3}
              className="group-hover:animate-bounce"
            /></Button
          ></a
        >
      </section>

      {/* Footer */}
      <Footer />
    </main>
  </div>

  {/* Scroll script */}
  <script>
    import "../scripts/scroll.js";
  </script>
</Layout>
